var currentUserURI,currentUser,userModified,identityForwardingComplement="\nIf identity forwarding is activated on a service,<br>this information may be forwarded to correspondant backends",userNameToolTip="User name is the login name used by a enduser to call protected services on publishing nodes."+identityForwardingComplement,passwordToolTip="End user password to call protected service on publishing nodes",firstNameToolTip="End user first name (Optional)"+identityForwardingComplement,lastNameToolTip=
"End user last name (Optional)"+identityForwardingComplement,entityNameToolTip="End user entity (Optional)"+identityForwardingComplement,mailNameToolTip="End user email"+identityForwardingComplement,userExtraToolTip="Any extra data at your choice (without \\n or \\n)"+identityForwardingComplement,endDateNameToolTip="From this date, user will not be alloed to connect publishing nodes anymore",addUserToolTip="Add a new user to the system",editUserToolTip="Edit this user (including its groups and quotas)",
deleteUserToolTip="Delete this user",editUserGroupsToolTip="Edit the group membership for this user",editUserQuotasToolTip="Define quotas for services requiring end users quotas management for this user",availableGroupsToolTip="List of available groups for which current user is not member<br>Multi selection is possible",deleteUserGroupToolTip="Remove current user for this group",addAllGroupsTooltip="Add user as member to selected groups",editQuota="Edit this quota",deleteQuota="Delete this quota",
userNameFilterPrevVal="",firstNameFilterPrevVal="",lastNameFilterPrevVal="",emailAddressFilterPrevVal="",entityFilterPrevVal="";function deleteUserQuotas(a,b){confirm("ZZOPEN echo Localization::getJSString(QUOTEuser.deleteQuota.confirmQUOTE)ZZCLOSE "+b+"?")&&$.ajax({url:a,dataType:"json",type:"DELETE",success:startDisplayUserQuotasForCurrentUser,error:displayErrorV2})}
function setUserModified(a){(userModified=a)?(setActionButtonEnabled("saveNew",!0),setActionButtonEnabled("saveEdit",!0),setActionButtonEnabled("groupsEdit",!1),setActionButtonEnabled("quotasEdit",!1)):(setActionButtonEnabled("saveNew",!1),setActionButtonEnabled("saveEdit",!1),setActionButtonEnabled("groupsEdit",!0),setActionButtonEnabled("quotasEdit",!0))}
function deleteUserGroup(a,b,c){confirm("ZZOPEN echo Localization::getJSString(QUOTEuser.deleteGroup.confirmQUOTE)ZZCLOSE "+b+"?")&&$.ajax({url:c+"/"+a,dataType:"json",type:"DELETE",success:startDisplayUserGroupsForCurrentUser,error:displayErrorV2})}
function addGroupToUser(a){grps=document.getElementById("availableGroupsList");for(i=selectedCount=0;i<grps.options.length;i++)grps.options[i].selected&&selectedCount++;currentItem=1;for(i=0;i<grps.options.length;i++)grps.options[i].selected&&(currentItem==selectedCount?onSuccess=startDisplayUserGroupsForCurrentUser:onSusccess=null,$.ajax({url:a+"/"+grps.options[i].value,dataType:"json",type:"POST",data:null,success:startDisplayUserGroupsForCurrentUser,error:displayErrorV2}),currentItem++);startDisplayUserGroups(a)}
function addUser(){$.get("resources/templates/userAdd.php",function(a){currentServiceGroup=currentService=null;$("#content").html(a.replaceAll("{userNameAsLabel}","").replaceAll("{userNameInputType}","text").replaceAll("{userNameToolTip}",userNameToolTip).replaceAll("{passwordToolTip}",passwordToolTip).replaceAll("{passwordToolTip}",passwordToolTip).replaceAll("{firstNameToolTip}",firstNameToolTip).replaceAll("{lastNameToolTip}",lastNameToolTip).replaceAll("{entityNameToolTip}",entityNameToolTip).replaceAll("{mailNameToolTip}",
mailNameToolTip).replaceAll("{endDateNameToolTip}",endDateNameToolTip).replaceAll("{userExtraToolTip}",userExtraToolTip).replaceAll("{userName}","").replaceAll("{password}","").replaceAll("{firstName}","").replaceAll("{lastName}","").replaceAll("{entity}","").replaceAll("{emailAddress}","").replaceAll("{endDate}","").replaceAll("{extra}",""));$("#userEndDate").datepicker();setUserModified(!1)})}function saveNewUser(){saveOrUpdateUser("POST")}function updateUser(a){saveOrUpdateUser("PUT")}
function saveOrUpdateUser(a){currentUserUri="users/"+encodeURIComponent(document.getElementById("userName").value);password="password="+encodeURIComponent(document.getElementById("userPass").value);userName="userName="+encodeURIComponent(document.getElementById("userName").value);email="email="+encodeURIComponent(document.getElementById("userMail").value);firstName="firstName="+encodeURIComponent(document.getElementById("firstName").value);lastName="lastName="+encodeURIComponent(document.getElementById("lastName").value);
entity="entity="+encodeURIComponent(document.getElementById("entity").value);extra="extra="+encodeURIComponent(document.getElementById("extra").value);try{d=Date.parseExact(document.getElementById("userEndDate").value,"ZZOPEN echo Localization::getJSString(QUOTEdate.formatQUOTE)ZZCLOSE"),d.setHours(12),endDate="endDate="+encodeURIComponent(d.format("isoUtcDateTime"))}catch(b){endDate="endDate="}postData=password+"&"+email+"&"+endDate+"&"+firstName+"&"+lastName+"&"+entity+"&"+extra;"POST"==a?(uri=
"users/",postData="userName="+encodeURIComponent(document.getElementById("userName").value)+"&"+postData):uri="users/"+encodeURIComponent(document.getElementById("userName").value);$.ajax({url:uri,dataType:"json",type:a,data:postData,success:startEditCurrentUser,error:displayErrorV2})}function startEditUser(a){currentUserUri=a;$.getJSON(a,editUser).error(displayErrorV2)}function startEditCurrentUser(){startEditUser(currentUserUri)}
function startDisplayAvailableGroups(a){currentUserURI=a;$.getJSON(a+"/groups/available/",displayAvailableGroups).error(displayErrorV2)}function startDisplayUserGroupsForCurrentUser(a){startDisplayUserGroups(currentUserURI)}function startDisplayUserGroups(a){currentUserURI=a;$.getJSON(a+"/groups/",displayUserGroups).error(displayErrorV2)}function startDisplayUserQuotas(a){currentUserURI=a;$.getJSON(a+"/quotas/",displayUserQuotas).error(displayErrorV2)}
function startDisplayUserQuotasForCurrentUser(){startDisplayUserQuotas(currentUserUri)}function displayAvailableGroups(a){0<a.length?$.each(a,function(a,c){$("#availableGroupsList").append($("<option>",{value:"groups/"+c.groupName,text:c.groupName}))}):$("#addGroups").hide()}
function editUser(a){$.get("resources/templates/userEdit.php",function(b){userDate=new Date(a.endDate);dateFormated=userDate.format("ZZOPEN echo Localization::getJSString(QUOTEdate.formatQUOTE)ZZCLOSE");currentUser=a;$("#content").html(b.replaceAll("{userNameAsLabel}",a.userName).replaceAll("{userNameInputType}","hidden").replaceAll("{userNameToolTip}",userNameToolTip).replaceAll("{editUserGroupsToolTip}",editUserGroupsToolTip).replaceAll("{editUserQuotasToolTip}",editUserQuotasToolTip).replaceAll("{passwordToolTip}",
passwordToolTip).replaceAll("{passwordToolTip}",passwordToolTip).replaceAll("{firstNameToolTip}",firstNameToolTip).replaceAll("{lastNameToolTip}",lastNameToolTip).replaceAll("{entityNameToolTip}",entityNameToolTip).replaceAll("{mailNameToolTip}",mailNameToolTip).replaceAll("{endDateNameToolTip}",endDateNameToolTip).replaceAll("{userExtraToolTip}",userExtraToolTip).replaceAll("{userName}",a.userName).replaceAll("{password}",a.password).replaceAll("{firstName}",a.firstName).replaceAll("{lastName}",
a.lastName).replaceAll("{entity}",a.entity).replaceAll("{emailAddress}",a.emailAddress).replaceAll("{endDate}",dateFormated).replaceAll("{extra}",null==a.extra?"":a.extra).replaceAll("{uri}",a.uri));$("#userEndDate").datepicker();setUserModified(!1)})}
function displayUserGroups(a){$.get("resources/templates/userGroups.php",function(b){$("#content").html(b.replaceAll("{availableGroupsToolTip}",availableGroupsToolTip).replaceAll("{addAllGroupsTooltip}",addAllGroupsTooltip).replaceAll("{currentUser.userName}",currentUser.userName).replaceAll("{currentUser.uri}",currentUser.uri));table=document.getElementById("data");rowPattern=document.getElementById("rowTpl");table.removeChild(rowPattern);if(0<a.length)for(i=0;i<a.length;i++)newRow=rowPattern.cloneNode(!0),
newRow.removeAttribute("id"),newRow.removeAttribute("style"),newRow.className=newRow.className+" tabular_table_body"+i%2,newRow.innerHTML=newRow.innerHTML.replaceAll("{groupList[i].groupName}",a[i].groupName).replaceAll("{deleteUserGroupToolTip}",deleteUserGroupToolTip).replaceAll("{currentUserURI}",currentUserURI).replaceAll("{groupList[i].description}",a[i].description),table.appendChild(newRow),edit=document.getElementById("btnEdit"),del=document.getElementById("btnDelete"),"Admin"==a[i].groupName&&
"Admin"==currentUser.userName?del.remove():del.removeAttribute("id");else $("#userGroupList").hide();startDisplayAvailableGroups(currentUserURI)})}
function displayUserQuotas(a){$.get("resources/templates/userQuotas.php",function(b){$("#content").html(b.replaceAll("{currentUser.userName}",currentUser.userName));table=document.getElementById("data");rowPattern=document.getElementById("rowTpl");table.removeChild(rowPattern);if(0<a.length)for(i=0;i<a.length;i++)newRow=rowPattern.cloneNode(!0),newRow.removeAttribute("id"),newRow.removeAttribute("style"),newRow.className=newRow.className+" tabular_table_body"+i%2,newRow.innerHTML=newRow.innerHTML.replaceAll("{quotasList[i].serviceName}",
a[i].serviceName).replaceAll("{quotasList[i].reqSec}",a[i].reqSec).replaceAll("{quotasList[i].reqDay}",a[i].reqDay).replaceAll("{quotasList[i].reqMonth}",a[i].reqMonth).replaceAll("{quotasList[i].uri}",a[i].uri).replaceAll("{editUserQuotasToolTip}",editUserQuotasToolTip).replaceAll("{deleteUserToolTip}",deleteUserToolTip),table.appendChild(newRow),edit=document.getElementById("btnEdit"),del=document.getElementById("btnDelete"),del.removeAttribute("id"),edit.removeAttribute("id");else $("#userQuotasList").hide()})}
function handelUserFilterFormKeypress(a){if(13==a.keyCode)return showUsers(),!1}
function displayUserList(a){$.get("resources/templates/userList.php",function(b){$("#content").html(b.replaceAll("{userList.length}",a.length).replaceAll("{userNameFilterPrevVal}",userNameFilterPrevVal).replaceAll("{emailAddressFilterPrevVal}",emailAddressFilterPrevVal).replaceAll("{entityFilterPrevVal}",entityFilterPrevVal).replaceAll("{firstNameFilterPrevVal}",firstNameFilterPrevVal).replaceAll("{lastNameFilterPrevVal}",lastNameFilterPrevVal));table=document.getElementById("data");rowPattern=document.getElementById("rowTpl");
table.removeChild(rowPattern);for(i=0;i<a.length;i++)b=new Date,b.setISO8601(a[i].endDate),newRow=rowPattern.cloneNode(!0),newRow.removeAttribute("id"),newRow.removeAttribute("style"),newRow.className=newRow.className+" tabular_table_body"+i%2,newRow.innerHTML=newRow.innerHTML.replaceAll("{userList[i].userName}",a[i].userName).replaceAll("{userList[i].emailAddress}",a[i].emailAddress).replaceAll("{userList[i].uri}",a[i].uri).replaceAll("{userList[i].endDate}",b.format("ZZOPEN echo Localization::getJSString(QUOTEdate.formatQUOTE)ZZCLOSE")),
table.appendChild(newRow),edit=document.getElementById("btnEdit"),del=document.getElementById("btnDelete"),"Admin"===a[i].userName?del.remove():del.removeAttribute("id"),edit.removeAttribute("id");0==a.length&&$("#usersList").hide()})}function deleteUser(a,b){confirm("ZZOPEN echo Localization::getJSString(QUOTEuser.delete.confirmQUOTE)ZZCLOSE "+b+"?")&&$.ajax({url:a,dataType:"json",type:"DELETE",success:showUsers,error:displayErrorV2})}
function resetUserFilter(){$("#userNameFilter").val("");$("#firstNameFilter").val("");$("#lastNameFilter").val("");$("#emailAddressFilter").val("");$("#entityFilter").val("");showUsers()}
function showUsers(){prms="order=userName";prms=prms+"&userNameFilter="+encodeURIComponent(getFilterValue("userNameFilter"));prms=prms+"&firstNameFilter="+encodeURIComponent(getFilterValue("firstNameFilter"));prms=prms+"&lastNameFilter="+encodeURIComponent(getFilterValue("lastNameFilter"));prms=prms+"&emailAddressFilter="+encodeURIComponent(getFilterValue("emailAddressFilter"));prms=prms+"&entityFilter="+encodeURIComponent(getFilterValue("entityFilter"));$.ajax({url:"./users/",dataType:"json",type:"GET",
data:prms,success:displayUserList,error:displayErrorV2})}$(function(){$("#listUser").click(resetUserFilter);$("#addUser").click(addUser)});
