#!/bin/bash
##--------------------------------------------------------
 # Module Name : ApplianceManager
 # Version : 1.0.0
 #
 # Software Name : OpenServicesAccess
 # Version : 1.0
 #
 # Copyright © 2011 – 2012 France Télécom
 # This software is distributed under the Apache 2 license
 # <http://www.apache.org/licenses/LICENSE-2.0.html>
 #
 #--------------------------------------------------------
 # File Name   : ApplianceManager/RunTimeAppliance/shell/doAppliance.sh
 #
 # Created     : 2012-02
 # Authors     : Benoit HERARD <benoit.herard(at)orange.com>
 #
 # Description :
 #      .../...
 #--------------------------------------------------------
 # History     :
 # 1.0.0 - 2012-10-01 : Release of the file
##

#!/bin/bash
#Generating endpoints entry for HTTP Host
unset http_proxy



# Configuration section #############################################################################
APPLIANCE_INSTALL_DIR=/usr/local/nursery/ApplianceManager
APPLIANCE_CONFIG_LOC=$APPLIANCE_INSTALL_DIR/RunTimeAppliance/apache/conf/vhAppliance
APPLIANCE_LOCAL_SERVER="http://127.0.0.1:82"
APPLIANCE_LOCAL_USER=""
APPLIANCE_LOCAL_PWD=""
HTTP_FQDN="r-lnx-jmjb0521.rd.francetelecom.fr"
HTTPS_FQDN="r-lnx-jmjb0521.rd.francetelecom.fr"
USE_HTTP=1
USE_HTTPS=1
# End of Configuration section #############################################################################


















if [ -f /etc/init.d/httpd ] ; then
	APACHE_INIT_SCRIPT=/etc/init.d/httpd
else
	if [ -f /etc/init.d/apache2 ] ; then
		APACHE_INIT_SCRIPT=/etc/init.d/apache2
	else
		echo "No /etc/init.d/httpd or /etc/init.d/apache2 script found exiting......"
		exit 1
	fi
fi


https=0;
http=0;

function generateConf(){
		
		if [ "$3" != "1" -a "$3" != "0" ] ; then 
			echo "Prameter 3 of generateConf (BasicAuth enabled) should be 0 or 1";
			exit 1
		fi
		if [ "$4" != "1" -a "$4" != "0" ] ; then 
			echo "Prameter 4 of generateConf (CookieAuthAuth enabled) should be 0 or 1";
			exit 1
		fi

		echo "Generating conf for $*"
        wget --user="$APPLIANCE_LOCAL_USER" --password="$APPLIANCE_LOCAL_PWD" "$APPLIANCE_LOCAL_SERVER/ApplianceManager/scripts/generateApacheConfig.php?domain=$1&BasicAuthEnabled=$3&CookieAuthEnabled=$4&node=$2" -O /tmp/applianceManagerServices.endpoints 2>&1
        [ ! -f $APPLIANCE_CONFIG_LOC/applianceManagerServices-node-$2.endpoints ] && touch $APPLIANCE_CONFIG_LOC/applianceManagerServices-node-$2.endpoints
        diffCount=`diff $APPLIANCE_CONFIG_LOC/applianceManagerServices-node-$2.endpoints /tmp/applianceManagerServices.endpoints | wc -l`
        echo "dc=$diffCount"
        if [ $diffCount -ne 0 ] ; then
                mv /tmp/applianceManagerServices.endpoints $APPLIANCE_CONFIG_LOC/applianceManagerServices-node-$2.endpoints
                Rc=1;
        else
                Rc=0;
        fi
        return $Rc
}
function deleteTempFiles(){
	ls /tmp/$$.* > /dev/null
	if [ $? -eq 0 ] ; then
		echo "Deleting temp files"
		rm /tmp/$$.*
	else
		echo "No file delete (/tmp/$$.*)"
	fi
}


function shellExit(){
	deleteTempFiles
	exit $1
}



echo "Starting $0 with $*"

if [ "$1" == "D" -o "$1" == "U"  -o "$1" == "C" ] ; then
	if [ "$1" == "U"  -o "$1" == "C" ] ; then
		curl -s --user "$APPLIANCE_LOCAL_USER:$APPLIANCE_LOCAL_PWD" $APPLIANCE_LOCAL_SERVER/ApplianceManager/nodes/$2>/tmp/$$.nodes
	else
		:>/tmp/$$.nodes
	fi
elif [ "$1" ==  "" ] ; then
	curl -s --user "$APPLIANCE_LOCAL_USER:$APPLIANCE_LOCAL_PWD" $APPLIANCE_LOCAL_SERVER/ApplianceManager/nodes/>/tmp/$$.nodes
fi
echo "" >>/tmp/$$.nodes



grep '"error"' /tmp/$$.nodes>/dev/null
if [ $? -eq 0 ] ; then
	echo "An error occursed while downloding node list"; 
	shellExit 1
fi

apacheReload=0;
while read line  
do   
	echo $line | grep "nodeName">/dev/null
	if [ $? -eq 0 ] ; then
		nodeName=`echo $line | awk -F\" '{print $4}'`
		echo "nodeName=$nodeName";
	fi
	echo $line | grep "serverFQDN">/dev/null
	if [ $? -eq 0 ] ; then
		serverFQDN=`echo $line | awk -F\" '{print $4}'`
		echo "serverFQDN=$serverFQDN";
	fi
	echo $line | grep "isCookieAuthEnabled">/dev/null
	if [ $? -eq 0 ] ; then
		isCookieAuthEnabled=`echo $line | awk -F\" '{print $4}'`
		echo "isCookieAuthEnabled=$isCookieAuthEnabled";
	fi
	echo $line | grep "isBasicAuthEnabled">/dev/null
	if [ $? -eq 0 ] ; then
		isBasicAuthEnabled=`echo $line | awk -F\" '{print $4}'`
		echo "isBasicAuthEnabled=$isBasicAuthEnabled";
	fi
	if [ "$line" == "}" -o "$line" == "}," ] ; then
		generateConf $serverFQDN $nodeName $isBasicAuthEnabled $isCookieAuthEnabled
		if [ $? -eq 1 ] ; then
			apacheReload=1;
		fi
	fi
done < /tmp/$$.nodes






if [ $apacheReload -eq 1 ] ; then
	$APACHE_INIT_SCRIPT graceful 2>&1
fi
